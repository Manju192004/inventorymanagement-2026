<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Billing</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <style>
      .invoice-box {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }
      .payment-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body class="bg-light">
    <div
      class="container-fluid min-vh-100 d-flex justify-content-center align-items-center py-4"
    >
      <div class="col-11 col-md-10 col-lg-8">
        <div class="invoice-box">
          <div class="row mb-4 border-bottom pb-3">
            <div class="col-6">
              <h2 class="fw-bold text-primary mb-0">INVOICE</h2>
              <small class="text-muted" id="order-id">#INV-0000</small>
            </div>
            <div class="col-6 text-end">
              <h5 class="fw-bold mb-0">My Shop Name</h5>
              <p class="small text-muted mb-0">
                123, Main Bazaar Street,<br />Tirunelveli, Tamil Nadu
              </p>
              <p id="current-date" class="small text-muted mb-0 pt-1"></p>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="fw-bold">Customer Info:</h6>
              <input
                type="text"
                id="cust-name"
                class="form-control form-control-sm mb-2"
                placeholder="Full Name"
                required
              />
              <textarea
                id="cust-address"
                class="form-control form-control-sm"
                rows="2"
                placeholder="Delivery Address"
                required
              ></textarea>
            </div>
          </div>

          <table class="table table-bordered mb-4">
            <thead class="table-dark">
              <tr>
                <th>Item</th>
                <th class="text-center">Qty</th>
                <th class="text-end">Price</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody id="billing-items"></tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="text-end">Grand Total:</th>
                <th class="text-end text-primary fs-5" id="grand-total">
                  ₹0.00
                </th>
              </tr>
            </tfoot>
          </table>

          <div class="payment-section mb-4">
            <h6 class="fw-bold mb-3">
              <i class="bi bi-credit-card-2-back me-2"></i>Payment Details
            </h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="small fw-bold">Payment Method</label>
                <select
                  class="form-select form-select-sm"
                  id="pay-method"
                  onchange="togglePaymentInputs()"
                >
                  <option value="Cash">Cash on Delivery</option>
                  <option value="GPay">UPI / GPay</option>
                </select>
              </div>
              <div class="col-md-6" id="cash-div">
                <label class="small fw-bold">Amount to Pay</label>
                <input
                  type="text"
                  id="cash-amount"
                  class="form-control form-control-sm"
                  readonly
                />
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between">
            <button
              class="btn btn-outline-secondary"
              onclick="window.history.back()"
            >
              Back
            </button>
            <button
              class="btn btn-success px-5 fw-bold"
              onclick="processOrder()"
            >
              PAY & FINISH
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 1. Cart-la irunthu motha list-aiyum edukkirom ('checkoutCart')
      const checkoutCart = JSON.parse(sessionStorage.getItem("checkoutCart"));
      // Oru vaelai single item "Buy Now" panniruntha adhaiyum handle panna:
      const singleItem = JSON.parse(sessionStorage.getItem("checkoutItem"));

      // Rendil ethu irukko adhai 'itemsToDisplay' list-ah maathikkurom
      let itemsToDisplay = [];
      if (checkoutCart && checkoutCart.length > 0) {
        itemsToDisplay = checkoutCart;
      } else if (singleItem) {
        itemsToDisplay = [singleItem];
      }

      window.onload = function () {
        document.getElementById("current-date").innerText =
          new Date().toLocaleDateString();
        document.getElementById("order-id").innerText =
          "#INV-" + Math.floor(1000 + Math.random() * 9000);
        loadItems();
      };

      function loadItems() {
        const billingTable = document.getElementById("billing-items");
        if (itemsToDisplay.length === 0) {
          billingTable.innerHTML =
            '<tr><td colspan="4" class="text-center text-danger">No items selected!</td></tr>';
          return;
        }

        let grandTotal = 0;
        billingTable.innerHTML = ""; // Pazhaya data-vai clear pannavum

        // 2. Loop panni ella items-aiyum table-la podurom
        itemsToDisplay.forEach((item) => {
          let qty = item.qty || 1;
          let itemPrice = parseFloat(item.price);
          let itemTotal = itemPrice * qty;
          grandTotal += itemTotal;

          billingTable.innerHTML += `
                <tr>
                    <td>${item.name}</td>
                    <td class="text-center">${qty}</td>
                    <td class="text-end">₹${itemPrice.toFixed(2)}</td>
                    <td class="text-end">₹${itemTotal.toFixed(2)}</td>
                </tr>`;
        });

        // 3. Grand total-ai update panrom
        document.getElementById("grand-total").innerText =
          "₹" + grandTotal.toFixed(2);
        document.getElementById("cash-amount").value =
          "₹" + grandTotal.toFixed(2);
      }

      function processOrder() {
        const custName = document.getElementById("cust-name").value;
        const orderId = document.getElementById("order-id").innerText;
        const totalAmount = document
          .getElementById("grand-total")
          .innerText.replace("₹", "");
        const payMethod = document.getElementById("pay-method").value; // Payment method edukkavum

        if (!custName) {
          alert("Please enter customer name");
          return;
        }

        // --- MUKKIYAM: Success Page-kkaga data-vai prepare pannunga ---
        const lastOrderData = {
          orderId: orderId,
          name: custName,
          total: totalAmount,
          method: payMethod,
          items: itemsToDisplay, // Ippo table-la irukura ella items-um inga varum
        };

        // Data-vai save pannunga
        sessionStorage.setItem("lastOrder", JSON.stringify(lastOrderData));

        // Flask backend-ukku data anuppuvadhai thodarung...
        itemsToDisplay.forEach((item) => {
          const orderData = {
            order_id: orderId,
            item_name: item.name,
            qty: item.qty || 1,
            total_price: parseFloat(item.price) * (item.qty || 1),
          };

          fetch("/place_order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderData),
          });
        });

        // Cart-ai clear panni redirect seiyavum
        let user = "{{ session['user'] }}" || "guest";
        localStorage.removeItem("myCart_" + user);
        sessionStorage.removeItem("checkoutCart");

        alert("Order Placed Successfully!");
        window.location.href = "/success"; // Inga redirect aagum podhu Summary page-la data theriyum
      }
    </script>
  </body>
</html>
